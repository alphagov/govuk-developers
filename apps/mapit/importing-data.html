
<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>mapit: MapIt - import postcode and boundary data - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/apps/mapit/importing-data.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="mapit: MapIt - import postcode and boundary data - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/apps/mapit/importing-data.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="mapit: MapIt - import postcode and boundary data" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/apps/mapit/importing-data.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/apps/by-team.html">
        <span>Application ownership by team</span>
      </a>
    </li>

      <li>
        <a href="/apps.html">
          <span>APIs</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/account-api.html"><span>account-api</span></a></li>
          <li><a href="/apps/asset-manager.html"><span>asset-manager</span></a></li>
          <li><a href="/apps/content-store.html"><span>content-store</span></a></li>
          <li><a href="/apps/email-alert-api.html"><span>email-alert-api</span></a></li>
          <li><a href="/apps/hmrc-manuals-api.html"><span>hmrc-manuals-api</span></a></li>
          <li><a href="/apps/imminence.html"><span>imminence</span></a></li>
          <li><a href="/apps/link-checker-api.html"><span>link-checker-api</span></a></li>
          <li><a href="/apps/mapit.html"><span>mapit</span></a></li>
          <li><a href="/apps/publishing-api.html"><span>publishing-api</span></a></li>
          <li><a href="/apps/router-api.html"><span>router-api</span></a></li>
          <li><a href="/apps/search-api.html"><span>search-api</span></a></li>
          <li><a href="/apps/support-api.html"><span>support-api</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Supporting apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/authenticating-proxy.html"><span>authenticating-proxy</span></a></li>
          <li><a href="/apps/content-data-admin.html"><span>content-data-admin</span></a></li>
          <li><a href="/apps/content-data-api.html"><span>content-data-api</span></a></li>
          <li><a href="/apps/govuk-load-testing.html"><span>govuk-load-testing</span></a></li>
          <li><a href="/apps/release.html"><span>release</span></a></li>
          <li><a href="/apps/router.html"><span>router</span></a></li>
          <li><a href="/apps/search-admin.html"><span>search-admin</span></a></li>
          <li><a href="/apps/signon.html"><span>signon</span></a></li>
          <li><a href="/apps/support.html"><span>support</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Transition apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/bouncer.html"><span>bouncer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/transition.html"><span>transition</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Services</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/cache-clearing-service.html"><span>cache-clearing-service</span></a></li>
          <li><a href="/apps/email-alert-service.html"><span>email-alert-service</span></a></li>
          <li><a href="/apps/search-analytics.html"><span>search-analytics</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>data.gov.uk apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/ckanext-datagovuk.html"><span>ckanext-datagovuk</span></a></li>
          <li><a href="/apps/datagovuk_find.html"><span>datagovuk_find</span></a></li>
          <li><a href="/apps/datagovuk_publish.html"><span>datagovuk_publish</span></a></li>
          <li><a href="/apps/datagovuk_reference.html"><span>datagovuk_reference</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Frontend apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/collections.html"><span>collections</span></a></li>
          <li><a href="/apps/email-alert-frontend.html"><span>email-alert-frontend</span></a></li>
          <li><a href="/apps/feedback.html"><span>feedback</span></a></li>
          <li><a href="/apps/finder-frontend.html"><span>finder-frontend</span></a></li>
          <li><a href="/apps/frontend.html"><span>frontend</span></a></li>
          <li><a href="/apps/government-frontend.html"><span>government-frontend</span></a></li>
          <li><a href="/apps/info-frontend.html"><span>info-frontend</span></a></li>
          <li><a href="/apps/licence-finder.html"><span>licence-finder</span></a></li>
          <li><a href="/apps/manuals-frontend.html"><span>manuals-frontend</span></a></li>
          <li><a href="/apps/service-manual-frontend.html"><span>service-manual-frontend</span></a></li>
          <li><a href="/apps/smart-answers.html"><span>smart-answers</span></a></li>
          <li><a href="/apps/static.html"><span>static</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Publishing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/collections-publisher.html"><span>collections-publisher</span></a></li>
          <li><a href="/apps/contacts-admin.html"><span>contacts-admin</span></a></li>
          <li><a href="/apps/content-publisher.html"><span>content-publisher</span></a></li>
          <li><a href="/apps/content-tagger.html"><span>content-tagger</span></a></li>
          <li><a href="/apps/local-links-manager.html"><span>local-links-manager</span></a></li>
          <li><a href="/apps/manuals-publisher.html"><span>manuals-publisher</span></a></li>
          <li><a href="/apps/maslow.html"><span>maslow</span></a></li>
          <li><a href="/apps/publisher.html"><span>publisher</span></a></li>
          <li><a href="/apps/service-manual-publisher.html"><span>service-manual-publisher</span></a></li>
          <li><a href="/apps/short-url-manager.html"><span>short-url-manager</span></a></li>
          <li><a href="/apps/specialist-publisher.html"><span>specialist-publisher</span></a></li>
          <li><a href="/apps/travel-advice-publisher.html"><span>travel-advice-publisher</span></a></li>
          <li><a href="/apps/whitehall.html"><span>whitehall</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>GOV.UK Account</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-account-manager-prototype.html"><span>govuk-account-manager-prototype</span></a></li>
          <li><a href="/apps/govuk-attribute-service-prototype.html"><span>govuk-attribute-service-prototype</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Utilities</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-alert-tracker.html"><span>govuk-alert-tracker</span></a></li>
          <li><a href="/apps/govuk-content-store-examples.html"><span>govuk-content-store-examples</span></a></li>
          <li><a href="/apps/govuk-dependencies.html"><span>govuk-dependencies</span></a></li>
          <li><a href="/apps/govuk-display-screen.html"><span>govuk-display-screen</span></a></li>
          <li><a href="/apps/govuk-docker.html"><span>govuk-docker</span></a></li>
          <li><a href="/apps/govuk-pact-broker.html"><span>govuk-pact-broker</span></a></li>
          <li><a href="/apps/govuk-puppet.html"><span>govuk-puppet</span></a></li>
          <li><a href="/apps/govuk-secondline-blinken.html"><span>govuk-secondline-blinken</span></a></li>
          <li><a href="/apps/govuk-zendesk-display-screen.html"><span>govuk-zendesk-display-screen</span></a></li>
          <li><a href="/apps/govuk_app_config.html"><span>govuk_app_config</span></a></li>
          <li><a href="/apps/seal.html"><span>seal</span></a></li>
          <li><a href="/apps/search-performance-explorer.html"><span>search-performance-explorer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/tech-docs-monitor.html"><span>tech-docs-monitor</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Data science</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-knowledge-graph.html"><span>govuk-knowledge-graph</span></a></li>
          <li><a href="/apps/govuk-related-links-recommender.html"><span>govuk-related-links-recommender</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Licensing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/licensify.html"><span>licensify</span></a></li>
          <li><a href="/apps/licensify-admin.html"><span>licensify-admin</span></a></li>
          <li><a href="/apps/licensify-feed.html"><span>licensify-feed</span></a></li>
        </ul>
      </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "mapit",
        "@id": "http://www.dev.gov.uk/apps/mapit.html"
      }
    }
  ]
}
</script>

<div class="gem-c-breadcrumbs govuk-breadcrumbs" data-module="gem-track-click">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="homeLinkClicked" data-track-action="homeBreadcrumb" data-track-label="" data-track-options="{}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="breadcrumbClicked" data-track-action="2" data-track-label="/apps.html" data-track-options="{&quot;dimension28&quot;:&quot;3&quot;,&quot;dimension29&quot;:&quot;Apps&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="breadcrumbClicked" data-track-action="3" data-track-label="/apps/mapit.html" data-track-options="{&quot;dimension28&quot;:&quot;3&quot;,&quot;dimension29&quot;:&quot;mapit&quot;}" class="govuk-breadcrumbs__link" href="/apps/mapit.html">mapit</a>
        </li>
  </ol>
</div>

  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">

  Last updated: <a href="https://github.com/alphagov/mapit/commit/d5fa20841b442a6e2acf0a85b094ad84033384f3">10 May 2021</a>
</div>

  <h1 class="page-title">mapit: MapIt - import postcode and boundary data</h1>

  
<h2 id="introduction">Introduction</h2>
<p><a href="https://github.com/alphagov/mapit">MapIt</a> is a product of
<a href="https://mysociety.org">MySociety</a> which we use within GOV.UK to allow
people to enter their postcode and be pointed to their local services.</p>
<p>It is composed of broadly 2 things:</p>
<ol>
<li>A database of postcodes and the location of their geographical
centre</li>
<li>A database of administrative entities (e.g. local councils) and
their boundaries on a map</li>
</ol>
<p>When a user enters a postcode on GOV.UK, MapIt will look it up to find
the geographical centre and then return information about the
administrative entities that postcode belongs to. We then use this
information to refer the user to local services provided by those
entities.</p>
<h2 id="updating-datasets">Updating Datasets</h2>
<p>Datasets for boundary lines are published twice a year (in May and
October) and postcodes are released four times a year (in February, May,
August and November). This means over time our database will become more
and more out of date and users will start to complain. When they do (or
before if possible) we should update the data.</p>
<p>To update a live mapit server we:</p>
<ol>
<li><a href="#generate-a-new-database">Generate a new database locally</a></li>
<li><a href="#export-new-database-to-s3">Export the new database to Amazon S3</a></li>
<li><a href="#update-servers-with-new-database">Update servers with the new database</a></li>
</ol>
<h3 id="1-generate-a-new-database">
<!-- raw HTML omitted -->1. Generate a new database<!-- raw HTML omitted -->
</h3>
<h4 id="1-1-prepare-your-mapit-installation">
<!-- raw HTML omitted -->1.1 Prepare your Mapit installation<!-- raw HTML omitted -->
</h4>
<p>Checkout the <a href="https://github.com/alphagov/mapit">mapit</a>,
<a href="https://github.com/alphagov/mapit-scripts">mapit-scripts</a> and
<a href="https://github.com/alphagov/govuk-docker">govuk-docker</a> repos.</p>
<p>Prepare your Mapit installation in Docker by:</p>
<ol>
<li>Running <code>make mapit</code> in the <code>govuk-docker</code> repo - this will build the image
and install all the dependencies.</li>
<li>Reset the database by running <code>govuk-docker run mapit-app ./reset-db.sh</code>
in the <code>mapit</code> repo (you can skip this step if you haven't run Mapit locally
before) - this will drop any existing database, create a new empty one
and migrate it to the empty schema. See the <a href="#troubleshooting">Troubleshooting</a>
section if you have issues.</li>
<li>Start your Docker container by running <code>govuk-docker up mapit-app</code>, and
check you are able to access <code>mapit.dev.gov.uk</code> - it is expected that the
frontend looks somewhat "broken", that's okay - we only need to worry about
the database for importing data.</li>
</ol>
<h4 id="1-2-download-the-latest-data-from-sources">
<!-- raw HTML omitted -->1.2 Download the latest data from sources<!-- raw HTML omitted -->
</h4>
<p>This consists of the <a href="https://geoportal.statistics.gov.uk/search?collection=Dataset&amp;q=ONS%20Postcode%20Directory">Office for National Statistics Postcode Database (ONSPD)</a>, <a href="https://osdatahub.os.uk/downloads/open/BoundaryLine">Ordnance Survey Boundary Line (BL)</a>, and <a href="http://osni.spatial-ni.opendata.arcgis.com/">Ordnance Survey of Northern Ireland (OSNI)</a> datasets.</p>
<blockquote>
<p>MySociety may have mirrored the latest datasets on their cache server: <a href="http://parlvid.mysociety.org/os/">http://parlvid.mysociety.org/os/</a> so check there first.</p>
</blockquote>
<ol>
<li>
<strong>ONS Postcode Database</strong> - ONSPD releases can be found via the Office
for National Statistics (ONS) by going to
<a href="http://geoportal.statistics.gov.uk/">http://geoportal.statistics.gov.uk/</a> and selecting the latest ONSPD
from the Postcodes product drop down.</li>
<li>
<strong>Boundary Line data</strong> - BL releases can be found via the Ordnance Survey (OS)
at
<a href="https://osdatahub.os.uk/downloads/open/BoundaryLine">https://osdatahub.os.uk/downloads/open/BoundaryLine</a> and select the
<code>ESRI Shapefile</code> format to download</li>
<li>
<strong>ONSI data</strong> - For the ONSI data we now point to Mysociety's URL in the
<a href="https://github.com/alphagov/mapit-scripts/blob/master/check-osni-downloads#L18">check-onsi-downloads</a> script, as there have not been any changes since December 2015.
It's still worth checking if there are any updates. See <a href="https://github.com/alphagov/mapit/blob/master/docs/docs/about-datasets.md">about datasets</a> for more information.</li>
</ol>
<h4 id="1-3-upload-the-latest-data-to-amazon-s3">
<!-- raw HTML omitted -->1.3 Upload the latest data to Amazon S3<!-- raw HTML omitted -->
</h4>
<p>Upload the latest ONS Postcode Database, Boundary Line, and OSNI datasets
to the <code>govuk-custom-formats-mapit-storage-production</code> S3 bucket. The path
should be of the format <code>source-data/&lt;year-month&gt;/&lt;filename&gt;</code>. Also ensure
that you have set the permissions for the datasets to be <code>public</code> so that
when you run the scripts later they are able to access the S3 files.</p>
<blockquote>
<p><strong>Note:</strong> the uploaded <code>&lt;filename&gt;</code> must match the naming convention
of the dataset files. This may not be case when initially downloaded.
For example, the ONSPD download for November 2018 is <code>2018-11</code>.
Files within <code>2018-11/data</code> are named <code>ONSPD_NOV_2018_UK.xxx</code>.
Before uploading in S3, rename folder <code>2018-11</code> to <code>ONSPD_NOV_2018_UK</code>.</p>
</blockquote>
<h4 id="1-4-update-url-paths-in-data-import-scripts">
<!-- raw HTML omitted -->1.4 Update URL paths in data import scripts<!-- raw HTML omitted -->
</h4>
<p>Update the <a href="https://github.com/alphagov/mapit-scripts/blob/master/import-uk-onspd">import-uk-onspd</a>
script in <code>mapit-scripts</code> to refer to the URLs of the new releases uploaded to
S3 in the <a href="#upload-latest-data">last step</a>.</p>
<p><strong>Note:</strong> If the ONSI data has been updated and uploaded to S3 update the
<a href="https://github.com/alphagov/mapit-scripts/blob/master/check-osni-downloads#L18">check-onsi-downloads</a> script to refer to the new S3 URL.</p>
<h4 id="1-5-start-running-the-import-script">
<!-- raw HTML omitted -->1.5 Start running the import script<!-- raw HTML omitted -->
</h4>
<p>In your Mapit directory run the <code>import-uk-onspd</code> script to import the data using Docker:</p>
<pre><code>$ govuk-docker run mapit-app ../mapit-scripts/import-uk-onspd
</code></pre>
<blockquote>
<p>This is a long process, it's importing 1000s of boundary objects and
~2.6 million postcodes, and <strong>takes at least 4.5 hours to run</strong>. The first hour is
particularly important to monitor as this is when it has typically failed
in the past.</p>
</blockquote>
<p>If the scripts fail you'll have to investigate why and possibly
update it to change how we import the data.</p>
<p>Some suggestions of places to look for help:</p>
<ul>
<li><a href="https://mapit.mysociety.org/docs/">Mysociety's documentation</a></li>
<li><a href="https://github.com/mysociety/mapit/issues">Mapit's logged issues</a></li>
<li><a href="/apps/mapit/HISTORY.html">Notes about the previous data import</a></li>
</ul>
<p>Also see the <a href="#troubleshooting">Troubleshooting</a> section for past issues.</p>
<p>If you do have to fix the import scripts, or create new ones, consider
talking with Mysociety developers to see if they're aware and if you can push
those changes back upstream.</p>
<blockquote>
<p><strong>Note:</strong> If the script fails, you'll need to drop and recreate
the database by running the <code>reset-db.sh</code> script and then run <code>import-uk-onspd</code>
again. If you have database issues see the <a href="#troubleshooting">troubleshooting</a>
section.</p>
</blockquote>
<h4 id="1-6-check-for-missing-codes">
<!-- raw HTML omitted -->1.6 Check for missing codes<!-- raw HTML omitted -->
</h4>
<p>The ONS used to identify areas with SNAC codes (called ONS
in mapit). They stopped doing this in 2011 and started using GSS
codes instead. New areas will not receive SNAC codes, and (for the
moment at least) much of GOV.UK relies on SNAC codes to link
things up, for example <a href="https://github.com/alphagov/frontend/blob/master/lib/authority_lookup.rb">Frontend's AuthorityLookup</a>.</p>
<p>The <code>import-uk-onspd</code> script's last action is to run a script to show missing codes.
It's the line that reads</p>
<pre><code>$MANAGE mapit_UK_show_missing_codes
</code></pre>
<p>This iterates over all area types we care about and lists those that
are missing a GSS code (hopefully none) and how many are missing an
ONS/SNAC code. If it lists any areas that are missing codes and you
don't expect them (run the script on production or integration if
you're not sure) you'll need to investigate.</p>
<p>Ssh into one of the machines and run:</p>
<pre><code>$ cd /var/apps/mapit
$ sudo -u deploy govuk_setenv mapit venv3/bin/python manage.py mapit_UK_show_missing_codes
</code></pre>
<p>Then compare the output with that generated in your local Docker container.</p>
<p>An example of the output (May 2019 data) - import looks good:</p>
<pre><code>    Show missing codes

    11874 areas in current generation (1)

    Checking ['EUR', 'CTY', 'DIS', 'LBO', 'LGD', 'MTD', 'UTA', 'COI'] for missing ['ons', 'gss', 'govuk_slug']
    12 EUR areas in current generation
      2 EUR areas have no ons code:
        Northern Ireland 11874 (gen 1-1) Northern Ireland
        Scotland 9199 (gen 1-1) Scotland
    26 CTY areas in current generation
    192 DIS areas in current generation
    33 LBO areas in current generation
    11 LGD areas in current generation
    36 MTD areas in current generation
    109 UTA areas in current generation
    1 COI areas in current generation
</code></pre>
<p>An example of the output (November 2020 data) - import has some flagged issues:</p>
<pre><code>    11870 areas in current generation (1)

    Checking ['EUR', 'CTY', 'DIS', 'LBO', 'LGD', 'MTD', 'UTA', 'COI'] for missing ['ons', 'gss', 'govuk_slug']
    12 EUR areas in current generation
      2 EUR areas have no ons code:
        Northern Ireland 11870 (gen 1-1) Northern Ireland
        Scotland 9195 (gen 1-1) Scotland
    25 CTY areas in current generation
    188 DIS areas in current generation
    33 LBO areas in current generation
    11 LGD areas in current generation
    36 MTD areas in current generation
    110 UTA areas in current generation
      1 UTA areas have no ons code:
        Buckinghamshire Council 1767 (gen 1-1) England
      1 UTA areas have no govuk_slug code:
        Buckinghamshire Council 1767 (gen 1-1) England
    1 COI areas in current generation
</code></pre>
<p>Note the last few lines where it says Buckinghamshire Council has no <code>ons</code> code or <code>govuk_slug</code> code.
You may have output similar to this if these councils have had some updates, and
you will have to make some additional updates in the code:</p>
<ul>
<li>Missing ONS/GSS codes are added in <a href="https://github.com/alphagov/mapit/blob/main/mapit_gb/management/commands/mapit_UK_add_missing_codes.py">mapit_UK_add_missing_codes.py</a>, see <a href="https://github.com/alphagov/mapit/commit/532f3e88ce0f5dea64b8f7eede6fb80605648e21">this example</a>
</li>
<li>An ONS/GSS code might need to be updated, or council names updated/removed in <a href="https://github.com/alphagov/mapit/blob/main/mapit_gb/data/authorities.json">authorities.json</a>, see <a href="https://github.com/alphagov/mapit/commit/b4d96ffa6160cfa9a8414383b96e6f1a8fa01b71">this example</a>
</li>
<li>If there are merged/abolished authorities, to prevent it from being flagged in the
next import's output (and potentially add to the confusion), you can add them to the
exception list in <a href="https://github.com/alphagov/mapit/blob/main/mapit_gb/management/commands/mapit_UK_add_override_names_to_local_authorities.py#L41">mapit_UK_add_override_names_to_local_authorities.py</a> and <a href="https://github.com/alphagov/mapit/blob/main/mapit_gb/management/commands/mapit_UK_add_slugs_to_local_authorities.py#L36">mapit_UK_add_slugs_to_local_authorities.py</a>. You can also check if the authority
is still active on <a href="https://findthatpostcode.uk/areas/E07000191.html">https://findthatpostcode.uk</a>
</li>
</ul>
<p>You will have to reset the db and re-import the data again.
Once these have been updated, the API will return the new GSS code, albeit mislabelled as an ONS code.</p>
<p><strong>Note</strong> <a href="https://github.com/alphagov/licensify">Licensify</a> also depends on knowledge of SNAC codes to build it's own API paths. It will be necessary to update this <a href="https://github.com/alphagov/licensify/blob/master/common/app/uk/gov/gds/licensing/model/SnacCodes.scala">file</a> with the new GSS codes and corresponding area.</p>
<h4 id="1-7-test-some-postcodes">
<!-- raw HTML omitted -->1.7 Test some postcodes<!-- raw HTML omitted -->
</h4>
<p>If you've had users complaining that their postcode isn't
recognised, then try <em>those</em> postcodes and any other ones
you know. You can get latest postcodes from <a href="https://checkmypostcode.uk/date/">https://checkmypostcode.uk/date/</a>
and test them on your local database:</p>
<pre><code>$ curl http://mapit.dev.gov.uk/postcode/ME206QZ
</code></pre>
<p>You should expect a <code>200</code> response with data present in the <code>areas</code>
field of the response. See <a href="https://github.com/alphagov/mapit#to-fetch-information-about-a-single-postcode">this example output</a>
for an idea of what to expect.</p>
<p>You can also compare the response to existing data we have in one of our environments
and on Mysociety.</p>
<pre><code>$ curl https://mapit.integration.govuk-internal.digital/postcode/ME206QZ
$ curl https://mapit.mysociety.org/postcode/ME206QZ
</code></pre>
<blockquote>
<p>Ensure you test postcodes from <strong>all parts of the UK</strong>, since Northern
Ireland data has been loaded separately.</p>
</blockquote>
<p>#### <!-- raw HTML omitted -->1.8 Make PRs for any changes you had to make<!-- raw HTML omitted --></p>
<p>You will have changed the <a href="https://github.com/alphagov/mapit-scripts/blob/master/import-uk-onspd">import-uk-onspd</a> and <a href="https://github.com/alphagov/mapit-scripts/blob/master/check-osni-download">check-onsi-downloads</a>
scripts to refer to new datasets. If anything failed you may have had
to change other things in the mapit repo too.</p>
<h3 id="-2-export-new-database-to-s3">
<!-- raw HTML omitted --> 2. Export new database to S3<!-- raw HTML omitted -->
</h3>
<p>Export the database you just built in your Docker container:</p>
<pre><code>$ govuk-docker run mapit-app pg_dump -U postgres mapit | gzip &gt; mapit.sql.gz
</code></pre>
<p><strong>It should be ~500Mb in size.</strong> You'll want to give it a name that refers
to what data it contains. Perhaps <code>mapit-&lt;%b%Y&gt;.sql.gz</code> (using
<code>strftime</code> parlance) for a standard release, or
<code>mapit-&lt;%b%Y&gt;-&lt;a-description-of-change&gt;.sql.gz</code> if you've had to change
the data outside the normal dataset releases.</p>
<p>Arrange to have the file you just created uploaded to the
<code>govuk-custom-formats-mapit-storage-production</code> S3 bucket, in the same folder
the new data has been uploaded to, and ensure that it's permission is set to <code>public</code>.</p>
<h3 id="3-test-a-server-in-staging">3. Test a server in Staging</h3>
<p><strong>NB: THIS REQUIRES ACCESS TO GOV.UK PRODUCTION</strong></p>
<p>Once the data has been uploaded change the URL and checksum (using
<code>sha1sum &lt;your-mapit-file.sql.gz&gt;</code>) reference in <code>import-db-from-s3.sh</code>
to refer to your new file, see <a href="https://github.com/alphagov/mapit/pull/58/files">this example PR</a>.
Submit change as a PR against <a href="https://github.com/alphagov/mapit">Mapit</a> and
deploy following the normal process to <code>staging</code>.</p>
<p>Before you can test updated data you will need to clear the shared cache. Refer
to <a href="https://docs.publishing.service.gov.uk/manual/mapit-cache.html">these docs</a> on how
to clear the cache.</p>
<blockquote>
<p>Testing on integration may not be as accurate as staging so we recommend testing on staging</p>
</blockquote>
<p>Now that your changes have been deployed, you can test the new database in
<code>AWS staging</code> before moving to <code>production</code>. See <a href="https://github.com/alphagov/mapit/blob/master/docs/docs/testing-server.md">Testing a server with an
updated Mapit database</a>.</p>
<p>Once you have tested that a new mapit node works as expected, you can
update each mapit node in turn using a <a href="https://github.com/alphagov/fabric-scripts/blob/master/mapit.py#L10">fabric
script</a>:</p>
<pre><code>$ fab $environment -H &lt;ip_address&gt; mapit.update_database_via_app
</code></pre>
<p>We can happily survive with one mapit-server in an environment while
this is done.</p>
<h3 id="4-update-production-servers-with-new-database">
<!-- raw HTML omitted -->4. Update production servers with new database<!-- raw HTML omitted -->
</h3>
<p>Now that you are happy with the changes in <code>staging</code>, you can now follow update
the servers in <code>production</code>.</p>
<blockquote>
<p><strong>Note: Only deploy this change to production once the new data has been tested
in staging. If a new Mapit machine gets created in AWS, it will automatically
try importing the data from the new database.</strong></p>
</blockquote>
<p>Remember to clear the shared cache otherwise old data may still be served.
Refer to <a href="https://docs.publishing.service.gov.uk/manual/mapit-caches.html">these
docs</a> on how
to clear the cache.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="useful-database-queries">Useful database queries</h3>
<ul>
<li>
<p>Find area by name</p>
<pre><code>  $ mapit=&gt; select * from mapit_area where name = 'Abbey';
</code></pre>
</li>
<li>
<p>Find area by id</p>
<pre><code>  $ mapit=&gt; select * from mapit_area where id=1767;
</code></pre>
</li>
<li>
<p>Find authority by name</p>
<pre><code>  $ mapit=&gt; select * from mapit_name where name like 'Buckinghamshire%';
</code></pre>
</li>
</ul>
<h3 id="unable-to-drop-the-database-when-running-the-reset-db-sh-script">Unable to drop the database when running the ./reset-db.sh script</h3>
<ol>
<li>
<p>Log into the database</p>
<pre><code>  $ python ./manage.py dbshell
</code></pre>
</li>
<li>
<p>Prevent future connections by running</p>
<pre><code> $ REVOKE CONNECT ON DATABASE mapit FROM public;
</code></pre>
</li>
<li>
<p>Terminate all connections to the database except your own:</p>
<pre><code> $ SELECT pid, pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = current_database() AND pid &lt;&gt; pg_backend_pid();
</code></pre>
</li>
</ol>
<p>Failing that, stop <code>collectd</code>, it probably connects again the moment the old connection gets terminated:</p>
<pre><code>$ sudo service collectd stop
</code></pre>
<h3 id="hitting-exceptions-where-an-area-has-a-missing-parent-or-spelt-incorrectly">Hitting exceptions where an area has a missing parent or spelt incorrectly</h3>
<p>If you see something similar to:</p>
<pre><code>get() returned more than one area -- it returned 2!
/var/govuk/mapit/mapit/management/find_parents.py:49
Exception: Area Moray [9325] (SPC) does not have a parent?
</code></pre>
<p>or:</p>
<pre><code>Exception: ONS code S17000011 is used for Highland and Islands PER and Highlands and Islands PER
</code></pre>
<p>Compare the entry with the database in <code>integration</code> or <code>staging</code> to identify what
information is missing or needs to be corrected. Searching for the data on
<a href="https://mapit.mysociety.org">https://mapit.mysociety.org</a> and checking the <a href="https://github.com/mysociety/mapit/issues">logged issues on Mysociety's repo</a>
might also be helpful. Also see <a href="#useful-database-queries">useful database queries</a>.</p>
<p>You can also search for the area by its ONS code on the ONS website e.g.
<a href="http://statistics.data.gov.uk/atlas/resource?uri=http://statistics.data.gov.uk/id/statistical-geography/S17000011">http://statistics.data.gov.uk/atlas/resource?uri=http://statistics.data.gov.uk/id/statistical-geography/S17000011</a></p>
<p>You can manually fix it by adding a correction in <a href="https://github.com/alphagov/mapit/blob/main/mapit/management/find_parents.py">mapit/management/find_parents.py</a>. See <a href="https://github.com/alphagov/mapit/commit/5b2ede155a157d7d69883a6a0197513bcbcca4bb">this example</a>
and <a href="https://github.com/alphagov/mapit/pull/70/files#diff-8e70109ed476fd7c998d2cd2a051297478b15d926e4c4d7645361197276292eeR203">this example</a>
for more information.</p>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/mapit/blob/main/docs/importing-data.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20''&amp;body=Problem%20with%20''%20(https://docs.publishing.service.gov.uk/apps/mapit/importing-data.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
