
<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>email-alert-api: 9. Sidekiq Lost Job Recovery - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/apps/email-alert-api/adr/adr-009-sidekiq-lost-job-recovery.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="email-alert-api: 9. Sidekiq Lost Job Recovery - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/apps/email-alert-api/adr/adr-009-sidekiq-lost-job-recovery.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="email-alert-api: 9. Sidekiq Lost Job Recovery" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/apps/email-alert-api/adr/adr-009-sidekiq-lost-job-recovery.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/apps/by-team.html">
        <span>Application ownership by team</span>
      </a>
    </li>

      <li>
        <a href="/apps.html">
          <span>APIs</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/account-api.html"><span>account-api</span></a></li>
          <li><a href="/apps/asset-manager.html"><span>asset-manager</span></a></li>
          <li><a href="/apps/content-store.html"><span>content-store</span></a></li>
          <li><a href="/apps/email-alert-api.html"><span>email-alert-api</span></a></li>
          <li><a href="/apps/hmrc-manuals-api.html"><span>hmrc-manuals-api</span></a></li>
          <li><a href="/apps/imminence.html"><span>imminence</span></a></li>
          <li><a href="/apps/link-checker-api.html"><span>link-checker-api</span></a></li>
          <li><a href="/apps/mapit.html"><span>mapit</span></a></li>
          <li><a href="/apps/publishing-api.html"><span>publishing-api</span></a></li>
          <li><a href="/apps/router-api.html"><span>router-api</span></a></li>
          <li><a href="/apps/search-api.html"><span>search-api</span></a></li>
          <li><a href="/apps/support-api.html"><span>support-api</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Supporting apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/authenticating-proxy.html"><span>authenticating-proxy</span></a></li>
          <li><a href="/apps/content-data-admin.html"><span>content-data-admin</span></a></li>
          <li><a href="/apps/content-data-api.html"><span>content-data-api</span></a></li>
          <li><a href="/apps/govuk-load-testing.html"><span>govuk-load-testing</span></a></li>
          <li><a href="/apps/release.html"><span>release</span></a></li>
          <li><a href="/apps/router.html"><span>router</span></a></li>
          <li><a href="/apps/search-admin.html"><span>search-admin</span></a></li>
          <li><a href="/apps/signon.html"><span>signon</span></a></li>
          <li><a href="/apps/support.html"><span>support</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Transition apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/bouncer.html"><span>bouncer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/transition.html"><span>transition</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Services</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/cache-clearing-service.html"><span>cache-clearing-service</span></a></li>
          <li><a href="/apps/email-alert-service.html"><span>email-alert-service</span></a></li>
          <li><a href="/apps/search-analytics.html"><span>search-analytics</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>data.gov.uk apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/ckanext-datagovuk.html"><span>ckanext-datagovuk</span></a></li>
          <li><a href="/apps/datagovuk_find.html"><span>datagovuk_find</span></a></li>
          <li><a href="/apps/datagovuk_publish.html"><span>datagovuk_publish</span></a></li>
          <li><a href="/apps/datagovuk_reference.html"><span>datagovuk_reference</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Frontend apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/collections.html"><span>collections</span></a></li>
          <li><a href="/apps/email-alert-frontend.html"><span>email-alert-frontend</span></a></li>
          <li><a href="/apps/feedback.html"><span>feedback</span></a></li>
          <li><a href="/apps/finder-frontend.html"><span>finder-frontend</span></a></li>
          <li><a href="/apps/frontend.html"><span>frontend</span></a></li>
          <li><a href="/apps/government-frontend.html"><span>government-frontend</span></a></li>
          <li><a href="/apps/info-frontend.html"><span>info-frontend</span></a></li>
          <li><a href="/apps/licence-finder.html"><span>licence-finder</span></a></li>
          <li><a href="/apps/manuals-frontend.html"><span>manuals-frontend</span></a></li>
          <li><a href="/apps/service-manual-frontend.html"><span>service-manual-frontend</span></a></li>
          <li><a href="/apps/smart-answers.html"><span>smart-answers</span></a></li>
          <li><a href="/apps/static.html"><span>static</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Publishing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/collections-publisher.html"><span>collections-publisher</span></a></li>
          <li><a href="/apps/contacts-admin.html"><span>contacts-admin</span></a></li>
          <li><a href="/apps/content-publisher.html"><span>content-publisher</span></a></li>
          <li><a href="/apps/content-tagger.html"><span>content-tagger</span></a></li>
          <li><a href="/apps/local-links-manager.html"><span>local-links-manager</span></a></li>
          <li><a href="/apps/manuals-publisher.html"><span>manuals-publisher</span></a></li>
          <li><a href="/apps/maslow.html"><span>maslow</span></a></li>
          <li><a href="/apps/publisher.html"><span>publisher</span></a></li>
          <li><a href="/apps/service-manual-publisher.html"><span>service-manual-publisher</span></a></li>
          <li><a href="/apps/short-url-manager.html"><span>short-url-manager</span></a></li>
          <li><a href="/apps/specialist-publisher.html"><span>specialist-publisher</span></a></li>
          <li><a href="/apps/travel-advice-publisher.html"><span>travel-advice-publisher</span></a></li>
          <li><a href="/apps/whitehall.html"><span>whitehall</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>GOV.UK Account</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-account-manager-prototype.html"><span>govuk-account-manager-prototype</span></a></li>
          <li><a href="/apps/govuk-attribute-service-prototype.html"><span>govuk-attribute-service-prototype</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Utilities</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-alert-tracker.html"><span>govuk-alert-tracker</span></a></li>
          <li><a href="/apps/govuk-content-store-examples.html"><span>govuk-content-store-examples</span></a></li>
          <li><a href="/apps/govuk-dependencies.html"><span>govuk-dependencies</span></a></li>
          <li><a href="/apps/govuk-display-screen.html"><span>govuk-display-screen</span></a></li>
          <li><a href="/apps/govuk-docker.html"><span>govuk-docker</span></a></li>
          <li><a href="/apps/govuk-pact-broker.html"><span>govuk-pact-broker</span></a></li>
          <li><a href="/apps/govuk-puppet.html"><span>govuk-puppet</span></a></li>
          <li><a href="/apps/govuk-secondline-blinken.html"><span>govuk-secondline-blinken</span></a></li>
          <li><a href="/apps/govuk-zendesk-display-screen.html"><span>govuk-zendesk-display-screen</span></a></li>
          <li><a href="/apps/govuk_app_config.html"><span>govuk_app_config</span></a></li>
          <li><a href="/apps/seal.html"><span>seal</span></a></li>
          <li><a href="/apps/search-performance-explorer.html"><span>search-performance-explorer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/tech-docs-monitor.html"><span>tech-docs-monitor</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Data science</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-knowledge-graph.html"><span>govuk-knowledge-graph</span></a></li>
          <li><a href="/apps/govuk-related-links-recommender.html"><span>govuk-related-links-recommender</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Licensing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/licensify.html"><span>licensify</span></a></li>
          <li><a href="/apps/licensify-admin.html"><span>licensify-admin</span></a></li>
          <li><a href="/apps/licensify-feed.html"><span>licensify-feed</span></a></li>
        </ul>
      </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "email-alert-api",
        "@id": "http://www.dev.gov.uk/apps/email-alert-api.html"
      }
    }
  ]
}
</script>

<div class="gem-c-breadcrumbs govuk-breadcrumbs" data-module="gem-track-click">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="homeLinkClicked" data-track-action="homeBreadcrumb" data-track-label="" data-track-options="{}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="breadcrumbClicked" data-track-action="2" data-track-label="/apps.html" data-track-options="{&quot;dimension28&quot;:&quot;3&quot;,&quot;dimension29&quot;:&quot;Apps&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-track-category="breadcrumbClicked" data-track-action="3" data-track-label="/apps/email-alert-api.html" data-track-options="{&quot;dimension28&quot;:&quot;3&quot;,&quot;dimension29&quot;:&quot;email-alert-api&quot;}" class="govuk-breadcrumbs__link" href="/apps/email-alert-api.html">email-alert-api</a>
        </li>
  </ol>
</div>

  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">

  Last updated: <a href="https://github.com/alphagov/email-alert-api/commit/053469603be30dcee91562df4427cac34d393c48">4 Dec 2020</a>
</div>

  <h1 class="page-title">email-alert-api: 9. Sidekiq Lost Job Recovery</h1>

  
<p>Date: 2020-12-02</p>
<h2 id="context">Context</h2>
<p>We use <a href="https://github.com/mperham/sidekiq">Sidekiq</a> to do background processing in Email Alert API. This includes critical tasks, such as generating and sending email. However, it's possible for these jobs to be lost:</p>
<ol>
<li>
<p>If the code to enqueue the job in Redis fails, either for transient reasons, or due to a bug.</p>
</li>
<li>
<p>If a worker process quits ungracefully, while processing a job.</p>
</li>
</ol>
<p>The second issue has occurred frequently due to workers being <a href="https://github.com/alphagov/govuk-puppet/blob/1258fc65da264191d01b4280cd4422f90085c371/modules/monitoring/files/usr/local/bin/event_handlers/govuk_app_high_memory.sh#L22">forcibly restarted</a> when they consume too much memory. A memorable example was the loss of a Travel Advice content change, which was detected by the <a href="https://github.com/alphagov/govuk-puppet/blob/be2e3733d9cad619d9cf57e19b190cd5d6116342/modules/govuk_jenkins/manifests/jobs/email_alert_check.pp">alert</a> for travel advice emails, and lead to an incident. Conversely, we don't think the first issue occurs frequently.</p>
<p>To help support engineers cope with certain kinds of lost work, we had <a href="https://github.com/alphagov/govuk-developer-docs/blob/7feaedc9bd9f786662055bba45327ddc8b318525/source/manual/alerts/email-alert-api-unprocessed-content-changes.html.md">manual steps</a> to recover it. We had this for the jobs to process content changes and <a href="https://github.com/alphagov/govuk-developer-docs/blob/7feaedc9bd9f786662055bba45327ddc8b318525/source/manual/alerts/email-alert-api-unprocessed-messages.html.md">messages</a>. The manual steps involved checking the state of the database, as an indication of whether jobs might have been lost. However, it's possible checking the database will turn up false positives e.g. if the system is running slowly. Both workers would <a href="https://github.com/alphagov/email-alert-api/commit/e4a8fedcaf2ce504f238ef53ee9fdf2e3319e30a#diff-ccd4e2b91347f03e81b4ccfae7983d17c508c7cce216a51596ccaf7093848a2cR6">double check</a> to prevent accidentally duplicating work.</p>
<p>Ideally these issues wouldn't exist in the first place. Previously we considered upgrading to Sidekiq Pro, which <a href="https://github.com/mperham/sidekiq/wiki/Reliability#using-super_fetch">persists</a> jobs in Redis while they are being processed. Using Sidekiq Pro would therefore prevent the second issue, but not the first, which is unrelated to Sidekiq. It's also worth noting that we previously had <a href="https://github.com/mperham/sidekiq/issues/4612">concerns</a> about switching to Sidekiq Pro, thinking it would be hard to use in practice. Still, it's possible the benefits could outweigh the drawbacks.</p>
<h2 id="decision">Decision</h2>
<p>We decided to implement a new <a href="https://github.com/alphagov/email-alert-api/blob/101f813d97c3838199e40643e681f1aca6adf67b/app/workers/recover_lost_jobs_worker.rb">worker</a> to automatically recover all work associated with generating and sending email. This resolves both of the above issues with lost work, and <a href="https://github.com/alphagov/govuk-developer-docs/blob/7feaedc9bd9f786662055bba45327ddc8b318525/source/manual/alerts/email-alert-api-unprocessed-content-changes.html.md">codifies</a> the previously manual recovery steps. Since there is little urgency around sending email, we decided to run the worker only infrequently (currently <a href="https://github.com/alphagov/email-alert-api/blob/59c37a1571d1564d1c63fd913274c810b0742ee6/config/sidekiq.yml#L39">every half hour</a>), for work that's <a href="https://github.com/alphagov/email-alert-api/blob/ea21e7cfd4f6131e2db55e45b923dee3895b081a/app/workers/recover_lost_jobs_worker/unprocessed_check.rb#L13">over an hour old</a> - we expect most work to have been processed within an hour.</p>
<p>An edge case for recovery is the initiation of the <a href="https://github.com/alphagov/email-alert-api/blob/bae78a3cb7e970d290d4a95613149c1d5d34e4f1/app/workers/daily_digest_initiator_worker.rb">daily</a> and <a href="https://github.com/alphagov/email-alert-api/blob/bae78a3cb7e970d290d4a95613149c1d5d34e4f1/app/workers/weekly_digest_initiator_worker.rb">weekly</a> digest runs. If one of these scheduled jobs is lost before it can <a href="https://github.com/alphagov/email-alert-api/blob/fe6ce7a61fa8ab6692786086c91d4d6017c9b2fa/app/services/digest_initiator_service.rb#L8">create</a> a DigestRun record, our normal strategy of checking the database won't work. For this scenario, we decided to have a <a href="https://github.com/alphagov/email-alert-api/blob/bae78a3cb7e970d290d4a95613149c1d5d34e4f1/app/workers/recover_lost_jobs_worker/missing_digest_runs_check.rb">separate</a> recovery strategy that's coupled to the <a href="https://github.com/alphagov/email-alert-api/blob/fe6ce7a61fa8ab6692786086c91d4d6017c9b2fa/config/sidekiq.yml#L17-L22">schedule</a> for the initiator jobs. The strategy involves looking back over the previous week to see if any DigestRun records are missing for that period.</p>
<p>We decided to pursue recovering lost work instead of acquiring Sidekiq Pro, which would help avoid the loss in the first place. We had the impression that the process to pay for, acquire and integrate Sidekiq Pro into Email Alert API would take longer to complete than implementing our own solution.</p>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="consequences">Consequences</h2>
<h3 id="potential-for-duplicate-work">Potential for duplicate work</h3>
<p>As mentioned in the context, it's possible we may recover work that still exists in the system. For example, a job that's over an hour old may simply be delayed due to an unusually high backlog in its Sidekiq queue. Although we could check the state of Sidekiq as part of finding lost work, it's still possible to have race conditions where we falsely requeue work that's not lost. To cope with this, we modified each worker so that it's <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>.</p>
<p>Each worker will <a href="https://github.com/alphagov/email-alert-api/commit/09a1474f8e075fdd442ced4a3bb723542fb09fea#diff-7f6369872e4b9658537b003a9c0fc119ac5f05745be3f7dad991d488e1b37ff1R23">double check</a> if it has previously completed. However, this could still be a false positive if duplicate jobs end up running concurrently. We had two approaches to cope with this:</p>
<ul>
<li>
<p>For slow jobs, like processing a content change, we used non-blocking <a href="https://github.com/alphagov/email-alert-api/blob/59c37a1571d1564d1c63fd913274c810b0742ee6/app/workers/process_content_change_worker.rb#L5">advisory locks</a>. This means any in-progress work that's been incorrectly recovered will be processed quickly as a <a href="https://github.com/alphagov/email-alert-api/blob/fe6ce7a61fa8ab6692786086c91d4d6017c9b2fa/app/workers/application_worker.rb#L7">no-op</a>.</p>
</li>
<li>
<p>For fast, high volume jobs, like sending an email, we used a blocking, <a href="https://github.com/alphagov/email-alert-api/blob/ea21e7cfd4f6131e2db55e45b923dee3895b081a/app/workers/send_email_worker.rb#L26">row-level lock</a> inside a transaction. Using a row-level lock is faster because the lock is part of the <code>SELECT</code> (... <code>FOR UPDATE</code>) statement we already execute to fetch the Email record. This is better for the common case, where there is no duplicate work. Even if duplicate work exists, it will only occupy a worker for a short time, until the original job completes and the lock is released.</p>
</li>
</ul>
<p>While making jobs idempotent means the system will behave correctly in the long term, in the short term it's still possible for the recovery to generate an alarming amount of "no-op" work on a queue e.g. if the system is running slowly. This is a particular concern for jobs to send email, where the queue latency can exceed one hour, with many thousands of fresh jobs in the queue. We used <a href="https://github.com/mhenrixon/sidekiq-unique-jobs">SidekiqUniqueJobs</a> to <a href="https://github.com/alphagov/email-alert-api/commit/ac08a4fdbcd691693dc9123e2902be451a4da69d">prevent</a> a snowball effect in this scenario.</p>
<h3 id="competing-with-sidekiq-retries">Competing with Sidekiq retries</h3>
<p>In creating the recovery worker we realised it would be in competition with the <a href="https://github.com/alphagov/email-alert-api/blob/ea21e7cfd4f6131e2db55e45b923dee3895b081a/app/workers/send_email_worker.rb#L11">retries</a> we have setup for jobs (or by <a href="https://github.com/mperham/sidekiq/wiki/Job-Lifecycle">default</a>). Sidekiq retries are faster than recovery, so it makes sense to continue using them.</p>
<p>However, the recovery worker could still generate a relatively large backlog of retrying work, if a job is perpetually failing due to a bug. We have tried to mitigate this by <a href="https://github.com/alphagov/email-alert-api/pull/1495/commits/df501d3edb7185ce35ab5592489765ec3699dae5">limiting</a> the number of retries for each job, but we could also consider using the <a href="https://github.com/alphagov/email-alert-api/commit/ac08a4fdbcd691693dc9123e2902be451a4da69d">unique jobs approach</a> for emails if this isn't enough. In the long term, we also plan to <a href="https://github.com/alphagov/email-alert-api/blob/master/docs/adr/adr-008-monitoring-and-alerting.md">improve the alerts</a> for the system, so that we can intervene in good time if work appears to be perpetually failing.</p>
<h3 id="delay-in-processing-lost-work">Delay in processing lost work</h3>
<p>In the worst case, it could take up to 1.5 hours to recover a piece of lost work. This is something we could tune if necessary e.g. for transactional emails, which should be sent within <a href="https://github.com/alphagov/email-alert-frontend/blob/de1caeea8098eccbb34d8768d7f2c95e455d901c/config/locales/subscriber_authentication.yml#L21">15 minutes</a>. We plan to consider this as part of our work on <a href="https://github.com/alphagov/email-alert-api/blob/master/docs/adr/adr-008-monitoring-and-alerting.md">improving the alerts</a> for the system. We also plan to reconsider using Sidekiq Pro as a more lightweight solution to speedy recovery, with the recovery worker as a fallback.</p>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/email-alert-api/blob/main/docs/adr/adr-009-sidekiq-lost-job-recovery.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20''&amp;body=Problem%20with%20''%20(https://docs.publishing.service.gov.uk/apps/email-alert-api/adr/adr-009-sidekiq-lost-job-recovery.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
