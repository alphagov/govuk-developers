




<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Low available disk space - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/alerts/low-available-disk-space.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Low available disk space - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/manual/alerts/low-available-disk-space.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Low available disk space" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/alerts/low-available-disk-space.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Low available disk space</span></a>
    <ul>
      <li>
        <a href="#low-available-disk-space-on-root"><span>Low available disk space on root</span></a>
      </li>
      <li>
        <a href="#low-available-disc-space-on-mntuploads-for-asset-master-1-and-asset-slave-1"><span>Low available disc space on /mnt/uploads for asset-master-1 and asset-slave-1</span></a>
      </li>
      <li>
        <a href="#low-available-disc-space-on-mntcrawler_worker-on-mirrorer"><span>Low available disc space on /mnt/crawler_worker on mirrorer</span></a>
        <ul>
          <li>
            <a href="#cause"><span>Cause</span></a>
          </li>
          <li>
            <a href="#solution"><span>Solution</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#no-disk-space-in-general"><span>No disk space in general</span></a>
      </li>
      <li>
        <a href="#disk-space-used-by-logfiles"><span>Disk space used by logfiles</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                <div class="information-callout">
      This page describes what to do in case of an
      <a href='https://docs.publishing.service.gov.uk/manual/tools.html#icinga'>Icinga alert</a>.
      For more information you could
      <a href='https://github.com/alphagov/govuk-puppet/search?utf8=%E2%9C%93&q=low-available-disk-space'>
        search the govuk-puppet repo for the source of the alert
      </a>
    </div>

    
   <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/govuk-developer-docs/commit/b4f3f7ea8dbad62455ab7a4ce03a375d1063690c">8 Dec 2020</a>
</div>

 <h1 id='header'>Low available disk space</h1> <h2 id='low-available-disk-space-on-root'>Low available disk space on root</h2><p>You can try clearing out the APT cache:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get clean
</code></pre></div><h2 id='low-available-disc-space-on-mntuploads-for-asset-master-1-and-asset-slave-1'>Low available disc space on /mnt/uploads for asset-master-1 and asset-slave-1</h2><p>Nagios is set up to monitor disc usage by /mnt/uploads on
asset-master-1.backend and asset-slave-1.backend. Usually, the culprit
behind space-chomping is /mnt/uploads/whitehall, and there are two
folders on which to focus clean-up efforts on:</p>

<ul>
<li><code>/mnt/uploads/whitehall/attachment-cache</code></li>
<li><code>/mnt/uploads/whitehall/carrierwave-tmp</code></li>
</ul>
<p>Running the following command from within the above folders (ie cd to
/mnt/uploads&hellip;) usually works best as it means that we don&rsquo;t end up
with the parent folders being deleted:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>find <span class="nt">-type</span> d <span class="nt">-ctime</span> +1 <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="o">{}</span> +
</code></pre></div><p>In the above example, we:</p>

<ul>
<li><code>find -type d</code> - find all directories within the folder you are currently
cd&rsquo;d in to</li>
<li><code>-ctime +1</code> - limit the results of the above <code>find</code> to files created over a
day (24hrs) ago</li>
<li><code>-exec rm -rf {} +</code> - execute a force removal on the folders found, with the
above conditions</li>
</ul>
<p>The + is a gnuism which allows the command to run more efficiently. This
<a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?find">man page</a> explains the +
functionality:</p>

<blockquote>
<p>This variant of the -exec option runs the specified command on the
selected files, but the command line is built by appending each
selected file name at the end; the total number of invoca-tions of the
command will be much less than the number of matched files. The
command line is built in much the same ways that xargs builds its
command lines. Only one instance of &lsquo;{}&rsquo; is allowed within the
command. The command is executed in the starting directory.</p>
</blockquote>
<p>This command will take a while to complete, depending - of course - on
how large your two starting folders are. After it has completed, push
Nagios to re-check the service on each affected host.</p>
<h2 id='low-available-disc-space-on-mntcrawler_worker-on-mirrorer'>Low available disc space on /mnt/crawler_worker on mirrorer</h2><p>This can be caused when the AWS autoscaler re-spins a VM and the newly created
VM does not attach the secondary EBS volume properly. In this case, the alert
will say <code>DISK CRITICAL: /mnt/crawler_worker not found</code>.</p>
<h3 id='cause'>Cause</h3><p>An EBS volume can only be attached to one VM at a time.  When the autoscaler
terminates a VM, AWS disconnects the EBS volume and releases a lock, whilst at
the same time also spinning up the replacement VM.  The new VM can spin up and be
provisioned faster than the lock can be released.</p>
<h3 id='solution'>Solution</h3><p>Manually re-attach the EBS volume tagged with mirrorer to the mirrorer
instance, then run puppet on the instance. This will cause puppet to correctly
mount the EBS volume in /mnt/crawler_worker.</p>

<ol>
<li>Login to the AWS Web Console: <code>gds aws govuk-integration-powerusers -l</code></li>
<li>Click Services -&gt; EC2</li>
<li>Change region to &ldquo;Europe (Ireland) eu-west-1&rdquo;</li>
<li>Click Instances on the left hand side menu bar and filter by &ldquo;mirrorer&rdquo;</li>
<li>Copy the Instance ID, it should look similar to <code>i-06887a467af1266a0</code></li>
<li>Left hand side menu, expand Elastic Block Store, and click Volumes</li>
<li>Filter by &ldquo;mirrorer&rdquo; and ensure that the state of the only result is &ldquo;available&rdquo;</li>
<li>Right click volume and choose &ldquo;Attach Volume&rdquo;</li>
<li>Paste the Instance ID in to the appropriate box, leaving Device as the default</li>
<li>Click Attach</li>
<li>After AWS finishes attaching the volume to the instance the state should change to &ldquo;in-use&rdquo;</li>
<li>Once it has settled to the &ldquo;in-use&rdquo; state, SSH in to the mirrorer instance and run <code>govuk_puppet --test</code></li>
</ol>
<h2 id='no-disk-space-in-general'>No disk space in general</h2><p>If you cant find any of the above cases causing low disk spaces, it can
be useful to run the command <code>sudo ncdu &lt;mountpoint&gt;</code>, where mountpoint
will be the path specified in the Nagios alert. It will calculate all
the disk space being used, and then bring you into an ncurses file
explorer-style interface. Press enter to go into a directory, and d to
delete any large files.</p>
<p>Press q to quit, or ? for help.</p>
<p>If a particular mountpoint is rather large, it may be helpful to first
scan it to see which directory inside it is using the most space, then
use ncdu on that directory. Do it with the following command:
<code>sudo du -hc --max-depth=1 &lt;mountpoint&gt;</code></p>
<p>If you are able to determine that the machine simply requires more disk space
to run the applications (such as a growing database) you can increase capacity
by:</p>

<ol>
<li><a href="https://docs.publishing.service.gov.uk/manual/manually-resize-ebs.html">Growing a persistent volume</a> in case of a stateful app</li>
<li>If the app is stateless and the volume ephemeral you can resize it in govuk-aws-data at data/&lt;app&gt;/&lt;env&gt;/common.tfvars and modify root_block_device_volume .You will then have to terminate the instances for them to be respawned by the autoscaling group with the new resized volume.</li>
</ol>
<h2 id='disk-space-used-by-logfiles'>Disk space used by logfiles</h2><p>You may discover that disk space is mostly being used up by logfiles.
This is probably caused by logrotate failing to properly rotate a
logfile for whatever reason, so it will probably just be one or two of
the latest logfiles using a high proportion of the disk space.</p>
<p>If it is out of hours, free up room to resolve the incident without
performing the maintenace tasks described below. Pass to 2ndline to deal
with during working hours.</p>
<p>Firstly see if you can remove any old logfiles, where dir is the
directory where the large file lives: <code>find &lt;dir&gt; -mtime +45 -type f</code></p>
<p>You can remove them by running: <code>find &lt;dir&gt; -mtime +45 -type f -delete</code></p>
<p>45 days is specified as this is how long we&rsquo;re obliged to keep logfiles,
but that could be smaller if required.</p>
<p>Ideally see if you can copy the large file elsewhere (on a different
mount point which has free space) and then entirely truncate that log:
<code>truncate -s 0 &lt;logfile&gt;</code>. Manually gzip the file (gzip &lt;file&gt;)
and put it back in the log file directory.</p>
<p>You can force a logrotate run afterwards:
<code>sudo logrotate -vf /etc/logrotate.d/&lt;type of logs&gt;</code></p>
<p><strong>If you have nowhere to move the logs and it is causing an incident,
uptime of the server takes precedent over logfiles, so just truncate the
logs to free up space</strong></p>


  <div class='related-content'>

</div>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/alerts/low-available-disk-space.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20'Low%20available%20disk%20space'&amp;body=Problem%20with%20'Low%20available%20disk%20space'%20(https://docs.publishing.service.gov.uk/manual/alerts/low-available-disk-space.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
